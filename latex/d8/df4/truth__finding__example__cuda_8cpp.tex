\hypertarget{truth__finding__example__cuda_8cpp}{}\doxysection{examples/run/cuda/truth\+\_\+finding\+\_\+example\+\_\+cuda.cpp File Reference}
\label{truth__finding__example__cuda_8cpp}\index{examples/run/cuda/truth\_finding\_example\_cuda.cpp@{examples/run/cuda/truth\_finding\_example\_cuda.cpp}}
{\ttfamily \#include \char`\"{}traccc/cuda/finding/finding\+\_\+algorithm.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/cuda/fitting/fitting\+\_\+algorithm.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/cuda/utils/stream.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/definitions/common.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/definitions/primitives.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/device/container\+\_\+d2h\+\_\+copy\+\_\+alg.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/device/container\+\_\+h2d\+\_\+copy\+\_\+alg.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/efficiency/finding\+\_\+performance\+\_\+writer.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/finding/finding\+\_\+algorithm.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/fitting/fitting\+\_\+algorithm.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/fitting/kalman\+\_\+filter/kalman\+\_\+fitter.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/io/read\+\_\+geometry.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/io/read\+\_\+measurements.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/io/utils.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/options/common\+\_\+options.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/options/detector\+\_\+input\+\_\+options.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/options/finding\+\_\+input\+\_\+options.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/options/handle\+\_\+argument\+\_\+errors.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/options/propagation\+\_\+options.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/performance/collection\+\_\+comparator.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/performance/container\+\_\+comparator.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/performance/timer.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/resolution/fitting\+\_\+performance\+\_\+writer.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}traccc/utils/seed\+\_\+generator.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/core/detector.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/core/detector\+\_\+metadata.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/detectors/bfield.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/io/common/detector\+\_\+reader.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/propagator/navigator.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/propagator/propagator.\+hpp\char`\"{}}\newline
{\ttfamily \#include \char`\"{}detray/propagator/rk\+\_\+stepper.\+hpp\char`\"{}}\newline
{\ttfamily \#include $<$vecmem/memory/cuda/device\+\_\+memory\+\_\+resource.\+hpp$>$}\newline
{\ttfamily \#include $<$vecmem/memory/cuda/host\+\_\+memory\+\_\+resource.\+hpp$>$}\newline
{\ttfamily \#include $<$vecmem/memory/cuda/managed\+\_\+memory\+\_\+resource.\+hpp$>$}\newline
{\ttfamily \#include $<$vecmem/memory/host\+\_\+memory\+\_\+resource.\+hpp$>$}\newline
{\ttfamily \#include $<$vecmem/utils/cuda/async\+\_\+copy.\+hpp$>$}\newline
{\ttfamily \#include $<$exception$>$}\newline
{\ttfamily \#include $<$iomanip$>$}\newline
{\ttfamily \#include $<$iostream$>$}\newline
Include dependency graph for truth\+\_\+finding\+\_\+example\+\_\+cuda.\+cpp\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d8/d2c/truth__finding__example__cuda_8cpp__incl}
\end{center}
\end{figure}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \mbox{\hyperlink{truth__finding__example__cuda_8cpp_a483872d7babdfe3e5898699c121250ed}{seq\+\_\+run}} (const \mbox{\hyperlink{structtraccc_1_1finding__input__config}{traccc\+::finding\+\_\+input\+\_\+config}} \&i\+\_\+cfg, const \mbox{\hyperlink{structtraccc_1_1propagation__options}{traccc\+::propagation\+\_\+options}}$<$ \mbox{\hyperlink{namespacetraccc_aab82ddc5db54d9ad84b1215320482993}{scalar}} $>$ \&propagation\+\_\+opts, const \mbox{\hyperlink{structtraccc_1_1common__options}{traccc\+::common\+\_\+options}} \&common\+\_\+opts, const \mbox{\hyperlink{structtraccc_1_1detector__input__options}{traccc\+::detector\+\_\+input\+\_\+options}} \&det\+\_\+opts, bool run\+\_\+cpu)
\item 
int \mbox{\hyperlink{truth__finding__example__cuda_8cpp_a0ddf1224851353fc92bfbff6f499fa97}{main}} (int argc, char $\ast$argv\mbox{[}$\,$\mbox{]})
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{truth__finding__example__cuda_8cpp_a0ddf1224851353fc92bfbff6f499fa97}\label{truth__finding__example__cuda_8cpp_a0ddf1224851353fc92bfbff6f499fa97}} 
\index{truth\_finding\_example\_cuda.cpp@{truth\_finding\_example\_cuda.cpp}!main@{main}}
\index{main@{main}!truth\_finding\_example\_cuda.cpp@{truth\_finding\_example\_cuda.cpp}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char $\ast$}]{argv\mbox{[}$\,$\mbox{]} }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{357                                  \{}
\DoxyCodeLine{358     \textcolor{comment}{// Set up the program options}}
\DoxyCodeLine{359     po::options\_description desc(\textcolor{stringliteral}{"Allowed options"});}
\DoxyCodeLine{360 }
\DoxyCodeLine{361     \textcolor{comment}{// Add options}}
\DoxyCodeLine{362     desc.add\_options()(\textcolor{stringliteral}{"help,h"}, \textcolor{stringliteral}{"Give some help with the program's options"});}
\DoxyCodeLine{363     \mbox{\hyperlink{structtraccc_1_1common__options}{traccc::common\_options}} common\_opts(desc);}
\DoxyCodeLine{364     \mbox{\hyperlink{structtraccc_1_1detector__input__options}{traccc::detector\_input\_options}} det\_opts(desc);}
\DoxyCodeLine{365     \mbox{\hyperlink{structtraccc_1_1finding__input__config}{traccc::finding\_input\_config}} finding\_input\_cfg(desc);}
\DoxyCodeLine{366     \mbox{\hyperlink{structtraccc_1_1propagation__options}{traccc::propagation\_options<scalar>}} propagation\_opts(desc);}
\DoxyCodeLine{367     desc.add\_options()(\textcolor{stringliteral}{"run\_cpu"}, po::value<bool>()-\/>default\_value(\textcolor{keyword}{false}),}
\DoxyCodeLine{368                        \textcolor{stringliteral}{"run cpu tracking as well"});}
\DoxyCodeLine{369 }
\DoxyCodeLine{370     po::variables\_map vm;}
\DoxyCodeLine{371     po::store(po::parse\_command\_line(argc, argv, desc), vm);}
\DoxyCodeLine{372 }
\DoxyCodeLine{373     \textcolor{comment}{// Check errors}}
\DoxyCodeLine{374     \mbox{\hyperlink{namespacetraccc_a018e1f5ae8dbab3e118c08cfb905be01}{traccc::handle\_argument\_errors}}(vm, desc);}
\DoxyCodeLine{375 }
\DoxyCodeLine{376     \textcolor{comment}{// Read options}}
\DoxyCodeLine{377     common\_opts.read(vm);}
\DoxyCodeLine{378     det\_opts.read(vm);}
\DoxyCodeLine{379 }
\DoxyCodeLine{380     finding\_input\_cfg.read(vm);}
\DoxyCodeLine{381     propagation\_opts.read(vm);}
\DoxyCodeLine{382     \textcolor{keyword}{auto} run\_cpu = vm[\textcolor{stringliteral}{"run\_cpu"}].as<\textcolor{keywordtype}{bool}>();}
\DoxyCodeLine{383 }
\DoxyCodeLine{384     std::cout << \textcolor{stringliteral}{"Running "} << argv[0] << \textcolor{stringliteral}{" "} << common\_opts.input\_directory}
\DoxyCodeLine{385               << \textcolor{stringliteral}{" "} << common\_opts.events << std::endl;}
\DoxyCodeLine{386 }
\DoxyCodeLine{387     \textcolor{keywordflow}{return} \mbox{\hyperlink{truth__finding__example__cuda_8cpp_a483872d7babdfe3e5898699c121250ed}{seq\_run}}(finding\_input\_cfg, propagation\_opts, common\_opts, det\_opts,}
\DoxyCodeLine{388                    run\_cpu);}
\DoxyCodeLine{389 \}}

\end{DoxyCode}


References traccc\+::common\+\_\+options\+::events, traccc\+::handle\+\_\+argument\+\_\+errors(), traccc\+::common\+\_\+options\+::input\+\_\+directory, traccc\+::detector\+\_\+input\+\_\+options\+::read(), traccc\+::finding\+\_\+input\+\_\+config\+::read(), traccc\+::common\+\_\+options\+::read(), traccc\+::propagation\+\_\+options$<$ scalar\+\_\+t $>$\+::read(), and seq\+\_\+run().

\mbox{\Hypertarget{truth__finding__example__cuda_8cpp_a483872d7babdfe3e5898699c121250ed}\label{truth__finding__example__cuda_8cpp_a483872d7babdfe3e5898699c121250ed}} 
\index{truth\_finding\_example\_cuda.cpp@{truth\_finding\_example\_cuda.cpp}!seq\_run@{seq\_run}}
\index{seq\_run@{seq\_run}!truth\_finding\_example\_cuda.cpp@{truth\_finding\_example\_cuda.cpp}}
\doxysubsubsection{\texorpdfstring{seq\_run()}{seq\_run()}}
{\footnotesize\ttfamily int seq\+\_\+run (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{structtraccc_1_1finding__input__config}{traccc\+::finding\+\_\+input\+\_\+config}} \&}]{i\+\_\+cfg,  }\item[{const \mbox{\hyperlink{structtraccc_1_1propagation__options}{traccc\+::propagation\+\_\+options}}$<$ \mbox{\hyperlink{namespacetraccc_aab82ddc5db54d9ad84b1215320482993}{scalar}} $>$ \&}]{propagation\+\_\+opts,  }\item[{const \mbox{\hyperlink{structtraccc_1_1common__options}{traccc\+::common\+\_\+options}} \&}]{common\+\_\+opts,  }\item[{const \mbox{\hyperlink{structtraccc_1_1detector__input__options}{traccc\+::detector\+\_\+input\+\_\+options}} \&}]{det\+\_\+opts,  }\item[{bool}]{run\+\_\+cpu }\end{DoxyParamCaption})}

Type declarations

Statistics
\begin{DoxyCode}{0}
\DoxyCodeLine{61                                                                         \{}
\DoxyCodeLine{62 }
\DoxyCodeLine{64     \textcolor{keyword}{using} host\_detector\_type = detray::detector<detray::default\_metadata,}
\DoxyCodeLine{65                                                 detray::host\_container\_types>;}
\DoxyCodeLine{66     \textcolor{keyword}{using} device\_detector\_type =}
\DoxyCodeLine{67         detray::detector<detray::default\_metadata,}
\DoxyCodeLine{68                          detray::device\_container\_types>;}
\DoxyCodeLine{69 }
\DoxyCodeLine{70     \textcolor{keyword}{using} b\_field\_t = covfie::field<detray::bfield::const\_bknd\_t>;}
\DoxyCodeLine{71     \textcolor{keyword}{using} rk\_stepper\_type =}
\DoxyCodeLine{72         detray::rk\_stepper<b\_field\_t::view\_t, \mbox{\hyperlink{namespacetraccc_a7d1f91ecd225f32ea85349bf0bc8adb8}{traccc::transform3}},}
\DoxyCodeLine{73                            detray::constrained\_step<>>;}
\DoxyCodeLine{74     \textcolor{keyword}{using} host\_navigator\_type = detray::navigator<const host\_detector\_type>;}
\DoxyCodeLine{75     \textcolor{keyword}{using} host\_fitter\_type =}
\DoxyCodeLine{76         \mbox{\hyperlink{classtraccc_1_1kalman__fitter}{traccc::kalman\_fitter<rk\_stepper\_type, host\_navigator\_type>}};}
\DoxyCodeLine{77     \textcolor{keyword}{using} device\_navigator\_type = detray::navigator<const device\_detector\_type>;}
\DoxyCodeLine{78     \textcolor{keyword}{using} device\_fitter\_type =}
\DoxyCodeLine{79         \mbox{\hyperlink{classtraccc_1_1kalman__fitter}{traccc::kalman\_fitter<rk\_stepper\_type, device\_navigator\_type>}};}
\DoxyCodeLine{80 }
\DoxyCodeLine{81     \textcolor{comment}{// Memory resources used by the application.}}
\DoxyCodeLine{82     vecmem::host\_memory\_resource host\_mr;}
\DoxyCodeLine{83     vecmem::cuda::host\_memory\_resource cuda\_host\_mr;}
\DoxyCodeLine{84     vecmem::cuda::managed\_memory\_resource mng\_mr;}
\DoxyCodeLine{85     vecmem::cuda::device\_memory\_resource device\_mr;}
\DoxyCodeLine{86     \mbox{\hyperlink{structtraccc_1_1memory__resource}{traccc::memory\_resource}} mr\{device\_mr, \&cuda\_host\_mr\};}
\DoxyCodeLine{87 }
\DoxyCodeLine{88     \textcolor{comment}{// Performance writer}}
\DoxyCodeLine{89     \mbox{\hyperlink{classtraccc_1_1finding__performance__writer}{traccc::finding\_performance\_writer}} find\_performance\_writer(}
\DoxyCodeLine{90         \mbox{\hyperlink{structtraccc_1_1finding__performance__writer_1_1config}{traccc::finding\_performance\_writer::config}}\{\});}
\DoxyCodeLine{91     \mbox{\hyperlink{classtraccc_1_1fitting__performance__writer}{traccc::fitting\_performance\_writer}} fit\_performance\_writer(}
\DoxyCodeLine{92         \mbox{\hyperlink{structtraccc_1_1fitting__performance__writer_1_1config}{traccc::fitting\_performance\_writer::config}}\{\});}
\DoxyCodeLine{93 }
\DoxyCodeLine{94     \textcolor{comment}{// Output Stats}}
\DoxyCodeLine{95     uint64\_t n\_found\_tracks = 0;}
\DoxyCodeLine{96     uint64\_t n\_found\_tracks\_cuda = 0;}
\DoxyCodeLine{97     uint64\_t n\_fitted\_tracks = 0;}
\DoxyCodeLine{98     uint64\_t n\_fitted\_tracks\_cuda = 0;}
\DoxyCodeLine{99 }
\DoxyCodeLine{100 \textcolor{comment}{    /*****************************}}
\DoxyCodeLine{101 \textcolor{comment}{     * Build a geometry}}
\DoxyCodeLine{102 \textcolor{comment}{     *****************************/}}
\DoxyCodeLine{103 }
\DoxyCodeLine{104     \textcolor{comment}{// B field value and its type}}
\DoxyCodeLine{105     \textcolor{comment}{// @TODO: Set B field as argument}}
\DoxyCodeLine{106     \textcolor{keyword}{const} \mbox{\hyperlink{namespacetraccc_a3e92464c509aa7ac245244b6083357c2}{traccc::vector3}} B\{0, 0, 2 * detray::unit<traccc::scalar>::T\};}
\DoxyCodeLine{107     \textcolor{keyword}{auto} field = detray::bfield::create\_const\_field(B);}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \textcolor{comment}{// Read the detector}}
\DoxyCodeLine{110     detray::io::detector\_reader\_config reader\_cfg\{\};}
\DoxyCodeLine{111     reader\_cfg.add\_file(\mbox{\hyperlink{namespacetraccc_1_1io_adc4b3b42d06cb8ec657cdc35dec6a58f}{traccc::io::data\_directory}}() + det\_opts.\mbox{\hyperlink{structtraccc_1_1detector__input__options_a1121f57fa16a57c9d2cef56f94390bcb}{detector\_file}});}
\DoxyCodeLine{112     \textcolor{keywordflow}{if} (!det\_opts.\mbox{\hyperlink{structtraccc_1_1detector__input__options_ad25e9f5ede26a98836d89f0fe4592e01}{material\_file}}.empty()) \{}
\DoxyCodeLine{113         reader\_cfg.add\_file(\mbox{\hyperlink{namespacetraccc_1_1io_adc4b3b42d06cb8ec657cdc35dec6a58f}{traccc::io::data\_directory}}() +}
\DoxyCodeLine{114                             det\_opts.\mbox{\hyperlink{structtraccc_1_1detector__input__options_ad25e9f5ede26a98836d89f0fe4592e01}{material\_file}});}
\DoxyCodeLine{115     \}}
\DoxyCodeLine{116     \textcolor{keywordflow}{if} (!det\_opts.\mbox{\hyperlink{structtraccc_1_1detector__input__options_a5b7ddcb0ffd9af5e0bdd7f841c38d380}{grid\_file}}.empty()) \{}
\DoxyCodeLine{117         reader\_cfg.add\_file(\mbox{\hyperlink{namespacetraccc_1_1io_adc4b3b42d06cb8ec657cdc35dec6a58f}{traccc::io::data\_directory}}() + det\_opts.\mbox{\hyperlink{structtraccc_1_1detector__input__options_a5b7ddcb0ffd9af5e0bdd7f841c38d380}{grid\_file}});}
\DoxyCodeLine{118     \}}
\DoxyCodeLine{119     \textcolor{keyword}{auto} [host\_det, names] =}
\DoxyCodeLine{120         detray::io::read\_detector<host\_detector\_type>(mng\_mr, reader\_cfg);}
\DoxyCodeLine{121 }
\DoxyCodeLine{122     \textcolor{keyword}{const} \textcolor{keyword}{auto} surface\_transforms = \mbox{\hyperlink{namespacetraccc_1_1io_a34c4958e67d33997fa0d3c0082169822}{traccc::io::alt\_read\_geometry}}(host\_det);}
\DoxyCodeLine{123 }
\DoxyCodeLine{124     \textcolor{comment}{// Detector view object}}
\DoxyCodeLine{125     \textcolor{keyword}{auto} det\_view = \mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{detray::get\_data}}(host\_det);}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{comment}{    /*****************************}}
\DoxyCodeLine{128 \textcolor{comment}{     * Do the reconstruction}}
\DoxyCodeLine{129 \textcolor{comment}{     *****************************/}}
\DoxyCodeLine{130 }
\DoxyCodeLine{131     \textcolor{comment}{// Stream object}}
\DoxyCodeLine{132     \mbox{\hyperlink{classtraccc_1_1cuda_1_1stream}{traccc::cuda::stream}} stream;}
\DoxyCodeLine{133 }
\DoxyCodeLine{134     \textcolor{comment}{// Copy object}}
\DoxyCodeLine{135     vecmem::cuda::async\_copy async\_copy\{stream.\mbox{\hyperlink{classtraccc_1_1cuda_1_1stream_ad8224b3cebfca8079e035a10a9b1e20f}{cudaStream}}()\};}
\DoxyCodeLine{136 }
\DoxyCodeLine{137     \mbox{\hyperlink{classtraccc_1_1device_1_1container__d2h__copy__alg}{traccc::device::container\_d2h\_copy\_alg}}<}
\DoxyCodeLine{138         \mbox{\hyperlink{structtraccc_1_1container__types}{traccc::track\_candidate\_container\_types}}>}
\DoxyCodeLine{139         track\_candidate\_d2h\{mr, async\_copy\};}
\DoxyCodeLine{140 }
\DoxyCodeLine{141     \mbox{\hyperlink{classtraccc_1_1device_1_1container__d2h__copy__alg}{traccc::device::container\_d2h\_copy\_alg<traccc::track\_state\_container\_types>}}}
\DoxyCodeLine{142         track\_state\_d2h\{mr, async\_copy\};}
\DoxyCodeLine{143 }
\DoxyCodeLine{144     \textcolor{comment}{// Standard deviations for seed track parameters}}
\DoxyCodeLine{145     \textcolor{keyword}{static} constexpr std::array<traccc::scalar, traccc::e\_bound\_size> stddevs =}
\DoxyCodeLine{146         \{1e-\/4 * detray::unit<traccc::scalar>::mm,}
\DoxyCodeLine{147          1e-\/4 * detray::unit<traccc::scalar>::mm,}
\DoxyCodeLine{148          1e-\/3,}
\DoxyCodeLine{149          1e-\/3,}
\DoxyCodeLine{150          1e-\/4 / detray::unit<traccc::scalar>::GeV,}
\DoxyCodeLine{151          1e-\/4 * detray::unit<traccc::scalar>::ns\};}
\DoxyCodeLine{152 }
\DoxyCodeLine{153     \textcolor{comment}{// Finding algorithm configuration}}
\DoxyCodeLine{154     \textcolor{keyword}{typename} \mbox{\hyperlink{classtraccc_1_1cuda_1_1finding__algorithm}{traccc::cuda::finding\_algorithm}}<}
\DoxyCodeLine{155         rk\_stepper\_type, device\_navigator\_type>::config\_type cfg;}
\DoxyCodeLine{156     cfg.min\_track\_candidates\_per\_track = i\_cfg.\mbox{\hyperlink{structtraccc_1_1finding__input__config_a24e62b30ce8ff203040556441f080f16}{track\_candidates\_range}}[0];}
\DoxyCodeLine{157     cfg.max\_track\_candidates\_per\_track = i\_cfg.\mbox{\hyperlink{structtraccc_1_1finding__input__config_a24e62b30ce8ff203040556441f080f16}{track\_candidates\_range}}[1];}
\DoxyCodeLine{158     cfg.constrained\_step\_size = propagation\_opts.\mbox{\hyperlink{structtraccc_1_1propagation__options_a81f0edca06f98598f6be3deef96e07f0}{step\_constraint}};}
\DoxyCodeLine{159 }
\DoxyCodeLine{160     \textcolor{comment}{// few tracks (\string~1 out of 1000 tracks) are missed when chi2\_max = 15}}
\DoxyCodeLine{161     cfg.chi2\_max = 30.f;}
\DoxyCodeLine{162 }
\DoxyCodeLine{163     \textcolor{comment}{// Finding algorithm object}}
\DoxyCodeLine{164     \mbox{\hyperlink{classtraccc_1_1finding__algorithm}{traccc::finding\_algorithm<rk\_stepper\_type, host\_navigator\_type>}}}
\DoxyCodeLine{165         host\_finding(cfg);}
\DoxyCodeLine{166     \mbox{\hyperlink{classtraccc_1_1cuda_1_1finding__algorithm}{traccc::cuda::finding\_algorithm<rk\_stepper\_type, device\_navigator\_type>}}}
\DoxyCodeLine{167         device\_finding(cfg, mr, async\_copy, stream);}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \textcolor{comment}{// Fitting algorithm object}}
\DoxyCodeLine{170     \textcolor{keyword}{typename} \mbox{\hyperlink{classtraccc_1_1fitting__algorithm_acfb92fd90e59587020bacc978ebe275c}{traccc::fitting\_algorithm<host\_fitter\_type>::config\_type}} fit\_cfg;}
\DoxyCodeLine{171     fit\_cfg.step\_constraint = propagation\_opts.\mbox{\hyperlink{structtraccc_1_1propagation__options_a81f0edca06f98598f6be3deef96e07f0}{step\_constraint}};}
\DoxyCodeLine{172 }
\DoxyCodeLine{173     \mbox{\hyperlink{classtraccc_1_1fitting__algorithm}{traccc::fitting\_algorithm<host\_fitter\_type>}} host\_fitting(fit\_cfg);}
\DoxyCodeLine{174     \mbox{\hyperlink{classtraccc_1_1cuda_1_1fitting__algorithm}{traccc::cuda::fitting\_algorithm<device\_fitter\_type>}} device\_fitting(}
\DoxyCodeLine{175         fit\_cfg, mr, async\_copy, stream);}
\DoxyCodeLine{176 }
\DoxyCodeLine{177     \mbox{\hyperlink{structtraccc_1_1performance_1_1timing__info}{traccc::performance::timing\_info}} elapsedTimes;}
\DoxyCodeLine{178 }
\DoxyCodeLine{179     \textcolor{comment}{// Seed generator}}
\DoxyCodeLine{180     \mbox{\hyperlink{structtraccc_1_1seed__generator}{traccc::seed\_generator<host\_detector\_type>}} sg(host\_det, stddevs);}
\DoxyCodeLine{181 }
\DoxyCodeLine{182     \textcolor{comment}{// Iterate over events}}
\DoxyCodeLine{183     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \mbox{\hyperlink{test__mapper_8cpp_aa79e3eff1ed8e629ebc8e3268c4805f9}{event}} = common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_ac0477bdb9a07bf525e12b006e141e094}{skip}};}
\DoxyCodeLine{184          \mbox{\hyperlink{test__mapper_8cpp_aa79e3eff1ed8e629ebc8e3268c4805f9}{event}} < common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_adefc317cdc0b846c7be8db1e5f0c3ef2}{events}} + common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_ac0477bdb9a07bf525e12b006e141e094}{skip}}; ++\mbox{\hyperlink{test__mapper_8cpp_aa79e3eff1ed8e629ebc8e3268c4805f9}{event}}) \{}
\DoxyCodeLine{185 }
\DoxyCodeLine{186         \textcolor{comment}{// Truth Track Candidates}}
\DoxyCodeLine{187         \mbox{\hyperlink{structtraccc_1_1event__map2}{traccc::event\_map2}} evt\_map2(\mbox{\hyperlink{test__mapper_8cpp_aa79e3eff1ed8e629ebc8e3268c4805f9}{event}}, common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_aec17933699762e2feb58124cef53d6b2}{input\_directory}},}
\DoxyCodeLine{188                                     common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_aec17933699762e2feb58124cef53d6b2}{input\_directory}},}
\DoxyCodeLine{189                                     common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_aec17933699762e2feb58124cef53d6b2}{input\_directory}});}
\DoxyCodeLine{190 }
\DoxyCodeLine{191         \mbox{\hyperlink{classtraccc_1_1host__container}{traccc::track\_candidate\_container\_types::host}} truth\_track\_candidates =}
\DoxyCodeLine{192             evt\_map2.generate\_truth\_candidates(sg, host\_mr);}
\DoxyCodeLine{193 }
\DoxyCodeLine{194         \textcolor{comment}{// Prepare truth seeds}}
\DoxyCodeLine{195         \mbox{\hyperlink{structtraccc_1_1collection__types_ab1b46d2f1f58a16bde873c1aa3f4557d}{traccc::bound\_track\_parameters\_collection\_types::host}} seeds(mr.host);}
\DoxyCodeLine{196         \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} n\_tracks = truth\_track\_candidates.\mbox{\hyperlink{classtraccc_1_1host__container_afb9ec4efd2a4fc601cafb57db9ebe30e}{size}}();}
\DoxyCodeLine{197         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i\_trk = 0; i\_trk < n\_tracks; i\_trk++) \{}
\DoxyCodeLine{198             seeds.push\_back(truth\_track\_candidates.\mbox{\hyperlink{classtraccc_1_1host__container_a22f19b70178832415310bb4fd17b9d48}{at}}(i\_trk).\mbox{\hyperlink{structtraccc_1_1container__element_acabcc54aaa8cd9c56d1f4969189de7d1}{header}});}
\DoxyCodeLine{199         \}}
\DoxyCodeLine{200 }
\DoxyCodeLine{201         \mbox{\hyperlink{structtraccc_1_1collection__types_af1bd16700947e48e7e095b96e552aba2}{traccc::bound\_track\_parameters\_collection\_types::buffer}} seeds\_buffer\{}
\DoxyCodeLine{202             \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}\textcolor{keyword}{>}(seeds.size()), mr.main\};}
\DoxyCodeLine{203         async\_copy.setup(seeds\_buffer);}
\DoxyCodeLine{204         async\_copy(\mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{vecmem::get\_data}}(seeds), seeds\_buffer,}
\DoxyCodeLine{205                    vecmem::copy::type::host\_to\_device);}
\DoxyCodeLine{206 }
\DoxyCodeLine{207         \textcolor{comment}{// Read measurements}}
\DoxyCodeLine{208         \mbox{\hyperlink{structtraccc_1_1io_1_1measurement__reader__output}{traccc::io::measurement\_reader\_output}} meas\_reader\_output(mr.host);}
\DoxyCodeLine{209         \mbox{\hyperlink{namespacetraccc_1_1io_a84e36824b32d23770ed527b25f810307}{traccc::io::read\_measurements}}(meas\_reader\_output, \mbox{\hyperlink{test__mapper_8cpp_aa79e3eff1ed8e629ebc8e3268c4805f9}{event}},}
\DoxyCodeLine{210                                       common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_aec17933699762e2feb58124cef53d6b2}{input\_directory}},}
\DoxyCodeLine{211                                       common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_a290ad4675f5a976c73c2a05e35dd1b5c}{input\_data\_format}});}
\DoxyCodeLine{212         \textcolor{keyword}{auto}\& measurements\_per\_event = meas\_reader\_output.measurements;}
\DoxyCodeLine{213 }
\DoxyCodeLine{214         \mbox{\hyperlink{structtraccc_1_1collection__types_af1bd16700947e48e7e095b96e552aba2}{traccc::measurement\_collection\_types::buffer}} measurements\_cuda\_buffer(}
\DoxyCodeLine{215             measurements\_per\_event.size(), mr.main);}
\DoxyCodeLine{216         async\_copy(\mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{vecmem::get\_data}}(measurements\_per\_event),}
\DoxyCodeLine{217                    measurements\_cuda\_buffer);}
\DoxyCodeLine{218 }
\DoxyCodeLine{219         \textcolor{comment}{// Instantiate output cuda containers/collections}}
\DoxyCodeLine{220         \mbox{\hyperlink{structtraccc_1_1container__buffer}{traccc::track\_candidate\_container\_types::buffer}}}
\DoxyCodeLine{221             track\_candidates\_cuda\_buffer\{\{\{\}, *(mr.host)\},}
\DoxyCodeLine{222                                          \{\{\}, *(mr.host), mr.host\}\};}
\DoxyCodeLine{223         async\_copy.setup(track\_candidates\_cuda\_buffer.headers);}
\DoxyCodeLine{224         async\_copy.setup(track\_candidates\_cuda\_buffer.items);}
\DoxyCodeLine{225 }
\DoxyCodeLine{226         \textcolor{comment}{// Navigation buffer}}
\DoxyCodeLine{227         \textcolor{keyword}{auto} navigation\_buffer = detray::create\_candidates\_buffer(}
\DoxyCodeLine{228             host\_det,}
\DoxyCodeLine{229             device\_finding.get\_config().max\_num\_branches\_per\_seed *}
\DoxyCodeLine{230                 seeds.size(),}
\DoxyCodeLine{231             mr.main, mr.host);}
\DoxyCodeLine{232 }
\DoxyCodeLine{233         \{}
\DoxyCodeLine{234             \mbox{\hyperlink{classtraccc_1_1performance_1_1timer}{traccc::performance::timer}} t(\textcolor{stringliteral}{"Track finding  (cuda)"}, elapsedTimes);}
\DoxyCodeLine{235 }
\DoxyCodeLine{236             \textcolor{comment}{// Run finding}}
\DoxyCodeLine{237             track\_candidates\_cuda\_buffer =}
\DoxyCodeLine{238                 device\_finding(det\_view, field, navigation\_buffer,}
\DoxyCodeLine{239                                measurements\_cuda\_buffer, seeds\_buffer);}
\DoxyCodeLine{240         \}}
\DoxyCodeLine{241 }
\DoxyCodeLine{242         \mbox{\hyperlink{classtraccc_1_1host__container}{traccc::track\_candidate\_container\_types::host}} track\_candidates\_cuda =}
\DoxyCodeLine{243             track\_candidate\_d2h(track\_candidates\_cuda\_buffer);}
\DoxyCodeLine{244 }
\DoxyCodeLine{245         \textcolor{comment}{// Instantiate cuda containers/collections}}
\DoxyCodeLine{246         \mbox{\hyperlink{structtraccc_1_1container__buffer}{traccc::track\_state\_container\_types::buffer}} track\_states\_cuda\_buffer\{}
\DoxyCodeLine{247             \{\{\}, *(mr.host)\}, \{\{\}, *(mr.host), mr.host\}\};}
\DoxyCodeLine{248 }
\DoxyCodeLine{249         \{}
\DoxyCodeLine{250             \mbox{\hyperlink{classtraccc_1_1performance_1_1timer}{traccc::performance::timer}} t(\textcolor{stringliteral}{"Track fitting  (cuda)"}, elapsedTimes);}
\DoxyCodeLine{251 }
\DoxyCodeLine{252             \textcolor{comment}{// Run fitting}}
\DoxyCodeLine{253             track\_states\_cuda\_buffer =}
\DoxyCodeLine{254                 device\_fitting(det\_view, field, navigation\_buffer,}
\DoxyCodeLine{255                                track\_candidates\_cuda\_buffer);}
\DoxyCodeLine{256         \}}
\DoxyCodeLine{257         \mbox{\hyperlink{classtraccc_1_1host__container}{traccc::track\_state\_container\_types::host}} track\_states\_cuda =}
\DoxyCodeLine{258             track\_state\_d2h(track\_states\_cuda\_buffer);}
\DoxyCodeLine{259 }
\DoxyCodeLine{260         \textcolor{comment}{// CPU containers}}
\DoxyCodeLine{261         \mbox{\hyperlink{classtraccc_1_1finding__algorithm}{traccc::finding\_algorithm}}<}
\DoxyCodeLine{262             rk\_stepper\_type, host\_navigator\_type>::output\_type track\_candidates;}
\DoxyCodeLine{263         \mbox{\hyperlink{classtraccc_1_1fitting__algorithm}{traccc::fitting\_algorithm<host\_fitter\_type>::output\_type}} track\_states;}
\DoxyCodeLine{264 }
\DoxyCodeLine{265         \textcolor{keywordflow}{if} (run\_cpu) \{}
\DoxyCodeLine{266 }
\DoxyCodeLine{267             \{}
\DoxyCodeLine{268                 \mbox{\hyperlink{classtraccc_1_1performance_1_1timer}{traccc::performance::timer}} t(\textcolor{stringliteral}{"Track finding  (cpu)"},}
\DoxyCodeLine{269                                              elapsedTimes);}
\DoxyCodeLine{270 }
\DoxyCodeLine{271                 \textcolor{comment}{// Run finding}}
\DoxyCodeLine{272                 track\_candidates = host\_finding(host\_det, field,}
\DoxyCodeLine{273                                                 measurements\_per\_event, seeds);}
\DoxyCodeLine{274             \}}
\DoxyCodeLine{275 }
\DoxyCodeLine{276             \{}
\DoxyCodeLine{277                 \mbox{\hyperlink{classtraccc_1_1performance_1_1timer}{traccc::performance::timer}} t(\textcolor{stringliteral}{"Track fitting  (cpu)"},}
\DoxyCodeLine{278                                              elapsedTimes);}
\DoxyCodeLine{279 }
\DoxyCodeLine{280                 \textcolor{comment}{// Run fitting}}
\DoxyCodeLine{281                 track\_states = host\_fitting(host\_det, field, track\_candidates);}
\DoxyCodeLine{282             \}}
\DoxyCodeLine{283         \}}
\DoxyCodeLine{284 }
\DoxyCodeLine{285         \textcolor{keywordflow}{if} (run\_cpu) \{}
\DoxyCodeLine{286 }
\DoxyCodeLine{287             \textcolor{comment}{// Show which event we are currently presenting the results for.}}
\DoxyCodeLine{288             std::cout << \textcolor{stringliteral}{"===>>> Event "} << \textcolor{keyword}{event} << \textcolor{stringliteral}{" <<<==="} << std::endl;}
\DoxyCodeLine{289             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} n\_matches = 0;}
\DoxyCodeLine{290             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < track\_candidates.size(); i++) \{}
\DoxyCodeLine{291                 \textcolor{keyword}{auto} iso = \mbox{\hyperlink{classtraccc_1_1details_1_1is__same__object}{traccc::details::is\_same\_object}}(}
\DoxyCodeLine{292                     track\_candidates.at(i).items);}
\DoxyCodeLine{293 }
\DoxyCodeLine{294                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < track\_candidates\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_afb9ec4efd2a4fc601cafb57db9ebe30e}{size}}();}
\DoxyCodeLine{295                      j++) \{}
\DoxyCodeLine{296                     \textcolor{keywordflow}{if} (iso(track\_candidates\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_a22f19b70178832415310bb4fd17b9d48}{at}}(j).\mbox{\hyperlink{structtraccc_1_1container__element_a7b11224d4a0d42c39758fb2b739014f2}{items}})) \{}
\DoxyCodeLine{297                         n\_matches++;}
\DoxyCodeLine{298                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{299                     \}}
\DoxyCodeLine{300                 \}}
\DoxyCodeLine{301             \}}
\DoxyCodeLine{302             std::cout << \textcolor{stringliteral}{"Track candidate matching Rate: "}}
\DoxyCodeLine{303                       << float(n\_matches) / track\_candidates.size()}
\DoxyCodeLine{304                       << std::endl;}
\DoxyCodeLine{305 }
\DoxyCodeLine{306             \textcolor{comment}{// Compare the track parameters made on the host and on the device.}}
\DoxyCodeLine{307             \mbox{\hyperlink{classtraccc_1_1collection__comparator}{traccc::collection\_comparator<traccc::fitter\_info<transform3>}}>}
\DoxyCodeLine{308                 compare\_fitter\_infos\{\textcolor{stringliteral}{"fitted tracks"}\};}
\DoxyCodeLine{309             compare\_fitter\_infos(}
\DoxyCodeLine{310                 \mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{vecmem::get\_data}}(track\_states.get\_headers()),}
\DoxyCodeLine{311                 \mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{vecmem::get\_data}}(track\_states\_cuda.\mbox{\hyperlink{classtraccc_1_1container__base_a72b19ad19ca520186db8f70baeafb679}{get\_headers}}()));}
\DoxyCodeLine{312         \}}
\DoxyCodeLine{313 }
\DoxyCodeLine{315         n\_found\_tracks += track\_candidates.size();}
\DoxyCodeLine{316         n\_fitted\_tracks += track\_states.size();}
\DoxyCodeLine{317         n\_found\_tracks\_cuda += track\_candidates\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_afb9ec4efd2a4fc601cafb57db9ebe30e}{size}}();}
\DoxyCodeLine{318         n\_fitted\_tracks\_cuda += track\_states\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_afb9ec4efd2a4fc601cafb57db9ebe30e}{size}}();}
\DoxyCodeLine{319 }
\DoxyCodeLine{320         \textcolor{keywordflow}{if} (common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_a06a875a852f866c6ad5abfaae82cb440}{check\_performance}}) \{}
\DoxyCodeLine{321             find\_performance\_writer.write(}
\DoxyCodeLine{322                 \mbox{\hyperlink{namespacetraccc_a503d2d50b981602cbc71693ad215b298}{traccc::get\_data}}(track\_candidates\_cuda), evt\_map2);}
\DoxyCodeLine{323 }
\DoxyCodeLine{324             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < track\_states\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_afb9ec4efd2a4fc601cafb57db9ebe30e}{size}}(); i++) \{}
\DoxyCodeLine{325                 \textcolor{keyword}{const} \textcolor{keyword}{auto}\& trk\_states\_per\_track =}
\DoxyCodeLine{326                     track\_states\_cuda.\mbox{\hyperlink{classtraccc_1_1host__container_a22f19b70178832415310bb4fd17b9d48}{at}}(i).\mbox{\hyperlink{structtraccc_1_1container__element_a7b11224d4a0d42c39758fb2b739014f2}{items}};}
\DoxyCodeLine{327 }
\DoxyCodeLine{328                 \textcolor{keyword}{const} \textcolor{keyword}{auto}\& fit\_info = track\_states\_cuda[i].header;}
\DoxyCodeLine{329 }
\DoxyCodeLine{330                 fit\_performance\_writer.write(trk\_states\_per\_track, fit\_info,}
\DoxyCodeLine{331                                              host\_det, evt\_map2);}
\DoxyCodeLine{332             \}}
\DoxyCodeLine{333         \}}
\DoxyCodeLine{334     \}}
\DoxyCodeLine{335 }
\DoxyCodeLine{336     \textcolor{keywordflow}{if} (common\_opts.\mbox{\hyperlink{structtraccc_1_1common__options_a06a875a852f866c6ad5abfaae82cb440}{check\_performance}}) \{}
\DoxyCodeLine{337         find\_performance\_writer.finalize();}
\DoxyCodeLine{338         fit\_performance\_writer.finalize();}
\DoxyCodeLine{339     \}}
\DoxyCodeLine{340 }
\DoxyCodeLine{341     std::cout << \textcolor{stringliteral}{"==> Statistics ... "} << std::endl;}
\DoxyCodeLine{342     std::cout << \textcolor{stringliteral}{"-\/ created (cuda) "} << n\_found\_tracks\_cuda << \textcolor{stringliteral}{" found tracks"}}
\DoxyCodeLine{343               << std::endl;}
\DoxyCodeLine{344     std::cout << \textcolor{stringliteral}{"-\/ created (cuda) "} << n\_fitted\_tracks\_cuda << \textcolor{stringliteral}{" fitted tracks"}}
\DoxyCodeLine{345               << std::endl;}
\DoxyCodeLine{346     std::cout << \textcolor{stringliteral}{"-\/ created  (cpu) "} << n\_found\_tracks << \textcolor{stringliteral}{" found tracks"}}
\DoxyCodeLine{347               << std::endl;}
\DoxyCodeLine{348     std::cout << \textcolor{stringliteral}{"-\/ created  (cpu) "} << n\_fitted\_tracks << \textcolor{stringliteral}{" fitted tracks"}}
\DoxyCodeLine{349               << std::endl;}
\DoxyCodeLine{350     std::cout << \textcolor{stringliteral}{"==>Elapsed times...\(\backslash\)n"} << elapsedTimes << std::endl;}
\DoxyCodeLine{351 }
\DoxyCodeLine{352     \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{353 \}}

\end{DoxyCode}


References traccc\+::io\+::alt\+\_\+read\+\_\+geometry(), traccc\+::host\+\_\+container$<$ header\+\_\+t, item\+\_\+t $>$\+::at(), traccc\+::common\+\_\+options\+::check\+\_\+performance, traccc\+::cuda\+::stream\+::cuda\+Stream(), traccc\+::io\+::data\+\_\+directory(), traccc\+::detector\+\_\+input\+\_\+options\+::detector\+\_\+file, event, traccc\+::common\+\_\+options\+::events, traccc\+::event\+\_\+map2\+::generate\+\_\+truth\+\_\+candidates(), traccc\+::cuda\+::finding\+\_\+algorithm$<$ stepper\+\_\+t, navigator\+\_\+t $>$\+::get\+\_\+config(), traccc\+::get\+\_\+data(), traccc\+::container\+\_\+base$<$ header\+\_\+t, item\+\_\+t, vector\+\_\+t, jagged\+\_\+vector\+\_\+t, pair\+\_\+t $>$\+::get\+\_\+headers(), traccc\+::detector\+\_\+input\+\_\+options\+::grid\+\_\+file, traccc\+::container\+\_\+element$<$ header\+\_\+reference\+\_\+t, vector\+\_\+reference\+\_\+t $>$\+::header, traccc\+::common\+\_\+options\+::input\+\_\+data\+\_\+format, traccc\+::common\+\_\+options\+::input\+\_\+directory, traccc\+::container\+\_\+element$<$ header\+\_\+reference\+\_\+t, vector\+\_\+reference\+\_\+t $>$\+::items, traccc\+::detector\+\_\+input\+\_\+options\+::material\+\_\+file, traccc\+::finding\+\_\+config$<$ scalar\+\_\+t $>$\+::max\+\_\+num\+\_\+branches\+\_\+per\+\_\+seed, traccc\+::io\+::measurement\+\_\+reader\+\_\+output\+::measurements, traccc\+::io\+::read\+\_\+measurements(), traccc\+::host\+\_\+container$<$ header\+\_\+t, item\+\_\+t $>$\+::size(), traccc\+::common\+\_\+options\+::skip, traccc\+::propagation\+\_\+options$<$ scalar\+\_\+t $>$\+::step\+\_\+constraint, and traccc\+::finding\+\_\+input\+\_\+config\+::track\+\_\+candidates\+\_\+range.



Referenced by main().

